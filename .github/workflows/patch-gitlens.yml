name: Patch GitLens VSIX (engines >= 1.81.0, only on new upstream)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Override upstream tag (e.g. v17.3.4). Leave empty to use upstream latest"
        required: false
        default: ""
      force:
        description: "Force republish even if same tag already exists"
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 0 * * *" # 每天 UTC 00:00（北京 08:00）

permissions:
  contents: write

env:
  UPSTREAM_REPO: eamodio/vscode-gitlens
  GH_TOKEN: ${{ github.token }}

jobs:
  patch-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (current repo)
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip unzip

      - name: Resolve upstream & local tags
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          # 1) upstream latest tag (or manually specified)
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            UPSTREAM_TAG="${{ github.event.inputs.tag }}"
          else
            UPSTREAM_TAG="$(gh release view -R "$UPSTREAM_REPO" --json tagName -q .tagName)"
          fi
          if [[ -z "$UPSTREAM_TAG" ]]; then
            echo "Failed to resolve upstream tag"; exit 1
          fi

          # 2) local latest release tag (may not exist)
          set +e
          LOCAL_TAG="$(gh release view --json tagName -q .tagName 2>/dev/null)"
          set -e
          echo "Upstream latest tag: $UPSTREAM_TAG"
          echo "Local   latest tag: ${LOCAL_TAG:-<none>}"

          # 3) whether to publish: local release not exists, or tag different, or manually force
          FORCE="${{ github.event.inputs.force }}"
          if [[ -z "${LOCAL_TAG:-}" || "$LOCAL_TAG" != "$UPSTREAM_TAG" || "$FORCE" == "true" ]]; then
            echo "changed=true"  >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
          echo "upstream_tag=$UPSTREAM_TAG" >> "$GITHUB_OUTPUT"

      - name: Skip if no new version (and not forced)
        if: steps.resolve.outputs.changed == 'false'
        run: |
          echo "No new upstream release (same tag as local) and force=false. Skipping gracefully."
          exit 0

      - name: Download upstream VSIX
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/vsix_src"
          gh release download "${{ steps.resolve.outputs.upstream_tag }}" -R "$UPSTREAM_REPO" -p "*.vsix" -D "$GITHUB_WORKSPACE/vsix_src"
          echo "Downloaded VSIX assets:"
          ls -lah "$GITHUB_WORKSPACE/vsix_src"
          VSIX_FILE="$(ls -1 "$GITHUB_WORKSPACE/vsix_src"/*.vsix | head -n1)"
          if [[ -z "${VSIX_FILE:-}" ]]; then
            echo "No VSIX asset found in upstream release"; exit 1
          fi
          echo "VSIX_FILE=$VSIX_FILE" >> "$GITHUB_ENV"

      - name: Patch engines.vscode to >=1.81.0
        id: patch
        shell: bash
        run: |
          set -euo pipefail
          echo "Using VSIX_FILE=$VSIX_FILE"
          WORKDIR="$(mktemp -d)"
          unzip -q "$VSIX_FILE" -d "$WORKDIR"

          # package.json may be in root or extension/ directory
          if [[ -f "$WORKDIR/extension/package.json" ]]; then
            PKG_PATH="$WORKDIR/extension/package.json"
          elif [[ -f "$WORKDIR/package.json" ]]; then
            PKG_PATH="$WORKDIR/package.json"
          else
            echo "package.json not found inside VSIX"; exit 1
          fi

          echo "Original engines.vscode:"
          jq -r '.engines.vscode // "N/A"' "$PKG_PATH"

          tmp="$(mktemp)"
          jq '.engines.vscode=">=1.81.0"' "$PKG_PATH" > "$tmp" && mv "$tmp" "$PKG_PATH"

          echo "Patched engines.vscode:"
          jq -r '.engines.vscode' "$PKG_PATH"

          OUT_NAME="gitlens-${{ steps.resolve.outputs.upstream_tag }}-patched_1.81.vsix"
          OUT_PATH="$GITHUB_WORKSPACE/$OUT_NAME"
          (cd "$WORKDIR" && zip -qr "$OUT_PATH" .)

          echo "OUT_NAME=$OUT_NAME" >> "$GITHUB_OUTPUT"
          echo "OUT_PATH=$OUT_PATH" >> "$GITHUB_OUTPUT"
          echo "Result file:"; ls -lah "$OUT_PATH"

      - name: Create or update release (graceful when exists)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.resolve.outputs.upstream_tag }}"
          OUT_PATH="${{ steps.patch.outputs.OUT_PATH }}"
          OUT_NAME="${{ steps.patch.outputs.OUT_NAME }}"
          FORCE="${{ github.event.inputs.force }}"

          echo "Will publish tag: $TAG"
          test -f "$OUT_PATH" || (echo "File not found: $OUT_PATH" && exit 1)

          if gh release view "$TAG" >/dev/null 2>&1; then
            if [[ "$FORCE" == "true" ]]; then
              echo "Release $TAG exists. FORCE=true → replace asset."
              if gh release view "$TAG" --json assets -q '.assets[].name' | grep -Fx "$OUT_NAME" >/dev/null 2>&1; then
                gh release delete-asset "$TAG" "$OUT_NAME" -y || true
              fi
              gh release upload "$TAG" "$OUT_PATH" --clobber
            else
              echo "Release $TAG already exists. FORCE=false → skip gracefully."
              exit 0
            fi
          else
            gh release create "$TAG" "$OUT_PATH" \
              --title "Patched GitLens $TAG (engines >= 1.81.0)" \
              --notes "Auto-patched from upstream $UPSTREAM_REPO@$TAG. engines.vscode set to >=1.81.0."
          fi

      - name: Summary
        run: |
          echo "Done. Tag: ${{ steps.resolve.outputs.upstream_tag }}"
